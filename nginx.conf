worker_processes auto;
events { worker_connections 1024; }

http {
  # Basiskomprimierung
  gzip on;
  gzip_types image/svg+xml application/json text/plain text/css application/javascript;

  server {
    listen 8080;

    location / {
      # IP-basierte Lösung (DNS-Workaround)
      # Supabase IPs: 104.18.38.10, 172.64.149.246
      set $supabase_ip 104.18.38.10;
      proxy_pass https://$supabase_ip/storage/v1/object/public$request_uri;

      # Wichtig: Host-Header für SSL/SNI
      proxy_set_header Host tmxhamdyrjuxwnskgfka.supabase.co;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto https;
      proxy_redirect off;
      
      # Timeout-Einstellungen
      proxy_connect_timeout 30s;
      proxy_send_timeout 30s;
      proxy_read_timeout 30s;
      
      # SSL-Optimierungen
      proxy_ssl_verify off;
      proxy_ssl_server_name on;
      proxy_ssl_protocols TLSv1.2 TLSv1.3;

      # CDN-Caching für statische Bilder
      expires 1y;
      add_header Cache-Control "public, max-age=31536000, immutable" always;
    }
  }
}
