worker_processes auto;
events { worker_connections 1024; }

http {
  # Basiskomprimierung (für SVG/JSON sinnvoll)
  gzip on;
  gzip_types image/svg+xml application/json text/plain text/css application/javascript;

  server {
    listen 8080;

    # Leite alle Anfragen 1:1 auf den Supabase public prefix weiter
    location / {
      # Mehrere DNS-Server für bessere Auflösung
      resolver 8.8.8.8 8.8.4.4 1.1.1.1 1.0.0.1 valid=300s ipv6=off;
      resolver_timeout 10s;
      
      # Hardcoded für tmxhamdyrjuxwnskgfka.supabase.co
      proxy_pass https://tmxhamdyrjuxwnskgfka.supabase.co/storage/v1/object/public$request_uri;

      proxy_set_header Host tmxhamdyrjuxwnskgfka.supabase.co;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto https;
      proxy_redirect off;
      
      # Timeout-Einstellungen
      proxy_connect_timeout 30s;
      proxy_send_timeout 30s;
      proxy_read_timeout 30s;
      
      # SSL-Einstellungen
      proxy_ssl_verify off;
      proxy_ssl_server_name on;
      proxy_ssl_protocols TLSv1.2 TLSv1.3;

      # Langes Caching für statische Bilder
      expires 1y;
      add_header Cache-Control "public, max-age=31536000, immutable" always;

      # CORS optional – auskommentiert lassen, falls nicht nötig
      # add_header Access-Control-Allow-Origin "*" always;
      # add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
      # add_header Access-Control-Allow-Headers "Origin, Accept, Content-Type, Authorization" always;
    }
  }
}
