worker_processes auto;
events { worker_connections 1024; }

http {
  # Basiskomprimierung
  gzip on;
  gzip_types image/svg+xml application/json text/plain text/css application/javascript;

  server {
    listen 8080;

    location / {
      # Zurück zur Hostname-basierten Lösung mit besserer SSL-Konfiguration
      resolver 8.8.8.8 8.8.4.4 1.1.1.1 valid=300s ipv6=off;
      resolver_timeout 30s;
      
      set $supabase_host tmxhamdyrjuxwnskgfka.supabase.co;
      proxy_pass https://$supabase_host/storage/v1/object/public$request_uri;

      proxy_set_header Host $supabase_host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto https;
      proxy_redirect off;
      
      # Erweiterte Timeout-Einstellungen
      proxy_connect_timeout 60s;
      proxy_send_timeout 60s;
      proxy_read_timeout 60s;
      
      # Verbesserte SSL-Konfiguration
      proxy_ssl_verify off;
      proxy_ssl_server_name on;
      proxy_ssl_protocols TLSv1.2 TLSv1.3;
      proxy_ssl_ciphers ECDHE+AESGCM:ECDHE+AES256:ECDHE+AES128:!aNULL:!MD5:!DSS;
      proxy_ssl_session_reuse on;

      # CDN-Caching für statische Bilder
      expires 1y;
      add_header Cache-Control "public, max-age=31536000, immutable" always;
    }
  }
}
